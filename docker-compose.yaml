services:
  postgres:
    image: postgres:latest
    networks:
      - pipe_network
    env_file:
      - ./config/.env


  init-airflow:
    image: apache/airflow:latest
    depends_on:
      - postgres
    networks:
      - pipe_network
    environment:
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgres+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB}
    command: >
      bash -c "airflow db init &&
                airflow users create --username ${AIRFLOW_USERNAME} --password ${AIRFLOW_PASSWORD} --firstname ${AIRFLOW_FIRSTNAME} --lastname ${AIRFLOW_LASTNAME} --role ${AIRFLOW_ROLE} --email ${AIRFLOW_EMAIL}"
    env_file:
      - ./config/.env

  webserver:
    build:  
      context: .
      dockerfile: Dockerfile
    user: root
    depends_on:
      - postgres
      - init-airflow
    networks:
      - pipe_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./scripts:/opt/airflow/scripts/
      - ./data:/opt/airflow/data/
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - LOAD_X = n
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgres+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB}
      - AIRFLOW_WWW_USER_USERNAME=${AIRFLOW_USERNAME}
      - AIRFLOW_WWW_USER_PASSWORD=${AIRFLOW_PASSWORD}
    env_file:
      - ./config/.env
      - ./config/airflow.cfg
    ports:
      - "8080:8080"
    command: webserver


  scheduler:
    build:  
      context: .
      dockerfile: Dockerfile
    user: root
    depends_on:
      - postgres
      - init-airflow
    networks:
      - pipe_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./scripts:/opt/airflow/scripts/
      - ./data:/opt/airflow/data/
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - LOAD_X = n
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgres+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB}
      - AIRFLOW_WWW_USER_USERNAME=${AIRFLOW_USERNAME}
      - AIRFLOW_WWW_USER_PASSWORD=${AIRFLOW_PASSWORD}
    env_file:
      - ./config/.env
      - ./config/airflow.cfg
    command: scheduler


networks:
  pipe_network:
    driver: bridge